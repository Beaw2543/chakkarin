<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมคู่อันดับสุดหรรษา</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styles */
        body {
            font-family: 'Kanit', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(to right bottom, #87CEEB, #FFF8DC, #FFDAB9); /* Sky blue, Cornsilk, PeachPuff */
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            color: #333;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Card-like Containers for main content and score board */
        #main-content, #score-board {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 100%;
            max-width: 700px; /* Max width for consistent look */
            margin-bottom: 25px;
            border: 2px solid #64B5F6; /* Brighter blue border */
            box-sizing: border-box;
            opacity: 0; /* Hidden by default for animation */
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Active state for visible containers */
        #main-content.active, #score-board.active {
            opacity: 1;
            transform: translateY(0);
        }
        /* Class to hide elements */
        .hidden {
            display: none;
        }

        /* Headings */
        h1 {
            color: #4A148C; /* Dark Purple */
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 2.2em;
        }
        /* Paragraph text */
        p {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
        }

        /* Canvas Styles for the graph */
        canvas {
            border: 3px solid #00C853; /* Vibrant Green border */
            background-color: #F8F8F8; /* Light gray for graph background */
            border-radius: 12px;
            width: 100%; /* Make canvas responsive */
            height: auto; /* Maintain aspect ratio */
            display: block;
            margin: 20px auto;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1); /* Subtle inner shadow */
        }

        /* Button Styles */
        button {
            padding: 14px 30px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin: 8px; /* Spacing between buttons */
            min-width: 150px; /* Ensure buttons have minimum width */
        }
        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Specific button colors */
        #start-game-btn {
            background-color: #FF6F00; /* Vibrant Orange */
            color: white;
            border-bottom: 4px solid #E65100;
        }
        #new-point-btn {
            background-color: #4CAF50; /* Green */
            color: white;
            border-bottom: 4px solid #388E3C;
        }
        #check-answer-btn {
            background-color: #2196F3; /* Bright Blue */
            color: white;
            border-bottom: 4px solid #1976D2;
        }
        #show-scores-btn {
            background-color: #9C27B0; /* Deep Purple */
            color: white;
            border-bottom: 4px solid #7B1FA2;
        }
        #back-to-game-btn {
            background-color: #607D8B; /* Blue Gray */
            color: white;
            border-bottom: 4px solid #455A64;
        }
        #reset-game-btn {
            background-color: #F44336; /* Red */
            color: white;
            border-bottom: 4px solid #D32F2F;
        }

        /* Input Group Styles */
        .input-group {
            margin-bottom: 18px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #6A1B9A; /* Purple-ish */
            font-size: 1.1em;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select {
            width: calc(100% - 24px); /* Full width with padding */
            padding: 12px;
            border: 2px solid #BBDEFB; /* Light Blue Border */
            border-radius: 8px;
            font-size: 1.1em;
            box-sizing: border-box; /* Include padding in width */
            background-color: #FDFEFE;
            color: #444;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #2196F3; /* Highlight Blue on focus */
            outline: none;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.3);
        }
        
        /* Answer Input Group for X, Y, and Quadrant */
        .answer-input-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* Spacing between inputs */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            font-size: 1.2em;
            font-weight: 700;
            color: #1A237E; /* Dark Blue */
        }
        .answer-input-group input {
            width: 80px; /* Fixed width for X and Y inputs */
            padding: 10px;
            text-align: center;
            border: 2px solid #9FA8DA;
            border-radius: 8px;
            font-size: 1.1em;
        }

        /* Information Displays (Player info, score, timer) */
        #player-info-display, #score-display, #timer-display {
            font-size: 1.3em;
            font-weight: 700;
            margin: 15px 0;
            color: #00796b; /* Teal */
        }
        #timer-display {
            font-size: 1.8em;
            color: #D32F2F; /* Red for timer */
            animation: pulse-timer 1.5s infinite alternate; /* Pulsing effect */
        }
        /* Keyframe animation for timer pulse */
        @keyframes pulse-timer {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.05); opacity: 0.9; }
        }

        /* Message and Feedback Area */
        #message {
            margin-top: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.15em;
            font-weight: 700;
            min-height: 50px; /* Ensure space for messages */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        /* Specific message styles */
        .correct {
            background-color: #E8F5E9; /* Light Green */
            color: #2E7D32; /* Dark Green */
            border: 1px solid #A5D6A7;
        }
        .wrong {
            background-color: #FFEBEE; /* Light Red */
            color: #C62828; /* Dark Red */
            border: 1px solid #EF9A9A;
        }
        .info {
            background-color: #E3F2FD; /* Light Blue */
            color: #1565C0; /* Dark Blue */
            border: 1px solid #90CAF9;
        }
        #your-answer, #correct-answer {
            font-weight: 600;
            color: #555;
            display: block;
            margin-top: 10px;
            font-size: 1.05em;
        }
        #correct-answer {
            color: #2E7D32; /* Green for correct answer display */
        }

        /* Score Board Specifics */
        #score-board table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background-color: #E1F5FE; /* Lighter blue table background */
            border-radius: 12px;
            overflow: hidden; /* Ensures rounded corners on table */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #score-board th, #score-board td {
            border: 1px solid #BBDEFB;
            padding: 12px;
            text-align: center;
            font-size: 0.95em;
        }
        #score-board th {
            background-color: #03A9F4; /* Bright Blue Header */
            color: white;
            font-weight: 700;
            text-transform: uppercase;
        }
        #score-board tr:nth-child(even) {
            background-color: #E8F5E9; /* Alternating light green row */
        }
        #score-board tr:hover {
            background-color: #C8E6C9; /* Hover effect */
        }

        /* Score Summary Section */
        .score-summary {
            margin-top: 20px;
            padding: 20px;
            background-color: #FFFDE7; /* Light Yellow */
            border-radius: 12px;
            text-align: left;
            border: 1px solid #FFECB3;
            box-shadow: inset 0 0 10px rgba(255,193,7,0.1);
        }
        .score-summary h3 {
            margin-top: 0;
            color: #FFC107; /* Amber */
            font-size: 1.5em;
            border-bottom: 2px solid #FFECB3;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .score-summary p {
            margin: 10px 0;
            color: #555;
            font-size: 1.1em;
            font-weight: 600;
        }

        /* Responsive Adjustments for smaller screens */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            p { font-size: 1em; }
            button {
                padding: 12px 20px;
                font-size: 1em;
                margin: 6px;
                min-width: unset; /* Remove min-width to allow shrinking */
                width: calc(50% - 12px); /* Two buttons per row */
            }
            #controls {
                flex-direction: row; /* Keep row for two buttons per row */
                justify-content: center;
                flex-wrap: wrap;
            }
            .answer-input-group {
                flex-direction: column; /* Stack inputs on small screens */
                gap: 8px;
            }
            .answer-input-group input {
                width: calc(100% - 20px); /* Full width for inputs */
            }
            .input-group label {
                font-size: 1em;
            }
            .input-group input[type="text"],
            .input-group input[type="number"],
            .input-group select {
                padding: 10px;
                font-size: 1em;
            }
            #player-info-display, #score-display, #timer-display {
                font-size: 1.1em;
            }
            #timer-display {
                font-size: 1.5em;
            }
            #score-board th, #score-board td {
                font-size: 0.85em;
                padding: 8px;
            }
            .score-summary h3 {
                font-size: 1.3em;
            }
            .score-summary p {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            #main-content, #score-board { padding: 15px; margin-bottom: 15px; }
            h1 { font-size: 1.6em; }
            button {
                width: calc(100% - 12px); /* One button per row */
            }
            .answer-input-group {
                font-size: 1em;
            }
            .answer-input-group input {
                width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
    <div id="main-content" class="active">
        <div id="start-form">
            <h1>🚀 เกมคู่อันดับสุดหรรษา 🚀</h1>
            <p>กรุณากรอกข้อมูลเพื่อเริ่มเกม</p>
            <div class="input-group">
                <label for="firstName">ชื่อ:</label>
                <input type="text" id="firstName" placeholder="ชื่อจริงของคุณ" required>
            </div>
            <div class="input-group">
                <label for="lastName">สกุล:</label>
                <input type="text" id="lastName" placeholder="นามสกุลของคุณ" required>
            </div>
            <div class="input-group">
                <label for="studentClass">ชั้น:</label>
                <input type="text" id="studentClass" placeholder="ตัวอย่าง: ม.3/1" required>
            </div>
            <div class="input-group">
                <label for="studentId">เลขที่:</label>
                <input type="number" id="studentId" placeholder="เลขที่ (เป็นตัวเลขเท่านั้น)" min="1" required>
            </div>
            <button id="start-game-btn">✨ เริ่มเกมกันเลย! ✨</button>
        </div>

        <div id="game-elements" class="hidden">
            <h1>🎯 คู่อันดับ & จตุภาค 🎯</h1>
            <p>ระบุคู่อันดับ (x, y) และจตุภาคของจุดบนกราฟ (ทั้งหมด 5 ข้อ)</p>
            <p id="player-info-display"></p>
            <p id="score-display">คะแนน: 0/0</p>
            <p id="timer-display">เวลาที่เหลือ: 30 วินาที</p>
            <canvas id="graphCanvas"></canvas>
            
            <div class="answer-input-group">
                <span>คู่อันดับ (</span>
                <input type="number" id="answerX" placeholder="x">
                <span>,</span>
                <input type="number" id="answerY" placeholder="y">
                <span>)</span>
            </div>
            <div class="input-group" style="width: fit-content; margin: 15px auto;">
                <label for="answerQuadrant">เลือกจตุภาค:</label>
                <select id="answerQuadrant">
                    <option value="">-- เลือกจตุภาค --</option>
                    <option value="จตุภาคที่ 1">จตุภาคที่ 1</option>
                    <option value="จตุภาคที่ 2">จตุภาคที่ 2</option>
                    <option value="จตุภาคที่ 3">จตุภาคที่ 3</option>
                    <option value="จตุภาคที่ 4">จตุภาคที่ 4</option>
                    <option value="บนแกน X">บนแกน X (บนแกนนอน)</option>
                    <option value="บนแกน Y">บนแกน Y (บนแกนตั้ง)</option>
                    <option value="จุดกำเนิด (0,0)">จุดกำเนิด (0,0)</option>
                </select>
            </div>

            <div id="controls">
                <button id="new-point-btn" style="display: none;">▶️ ข้อต่อไป</button> 
                <button id="check-answer-btn">✅ ตรวจสอบคำตอบ</button>
                <button id="show-scores-btn">🏆 ดูคะแนนรวม</button>
                <button id="reset-game-btn">🔄 เล่นใหม่ (เปลี่ยนผู้เล่น)</button>
            </div>
            <p>คำตอบของคุณ: <span id="your-answer">-- รอคำตอบ --</span></p>
            <p>คำตอบที่ถูกต้อง: <span id="correct-answer"></span></p>
            <div id="message"></div>
        </div>
    </div>

    <div id="score-board" class="hidden">
        <h1>📊 สถิติผู้เข้าเล่น 📊</h1>
        <div class="score-summary">
            <h3>สรุปคะแนนรวมแต่ละคน</h3>
            <div id="individual-scores-summary">
                </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ลำดับ</th>
                    <th>ชื่อ</th>
                    <th>สกุล</th>
                    <th>ชั้น</th>
                    <th>เลขที่</th>
                    <th>คะแนน</th>
                    <th>วันที่/เวลา</th>
                </tr>
            </thead>
            <tbody id="scores-table-body">
                </tbody>
        </table>
        <button id="back-to-game-btn">🎮 กลับสู่เกม</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>

    <script>
        // --- DOM Elements ---
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const newPointBtn = document.getElementById('new-point-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const answerXInput = document.getElementById('answerX');
        const answerYInput = document.getElementById('answerY');
        const answerQuadrantSelect = document.getElementById('answerQuadrant');
        const yourAnswerSpan = document.getElementById('your-answer');
        const correctAnswerSpan = document.getElementById('correct-answer');
        const messageDiv = document.getElementById('message');
        const scoreDisplay = document.getElementById('score-display');
        const playerInfoDisplay = document.getElementById('player-info-display');
        const timerDisplay = document.getElementById('timer-display');

        const mainContent = document.getElementById('main-content');
        const startForm = document.getElementById('start-form');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const studentClassInput = document.getElementById('studentClass');
        const studentIdInput = document.getElementById('studentId');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameElements = document.getElementById('game-elements');

        const scoreBoard = document.getElementById('score-board');
        const scoresTableBody = document.getElementById('scores-table-body'); 
        const individualScoresSummaryDiv = document.getElementById('individual-scores-summary');
        const showScoresBtn = document.getElementById('show-scores-btn');
        const backToGameBtn = document.getElementById('back-to-game-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');

        // --- Game Constants and Variables ---
        const ORIGINAL_CANVAS_SIZE = 400; // Reference size for scaling
        let CANVAS_SIZE; // Dynamic canvas size based on window/container
        let GRID_STEP; // Size of each grid unit
        let ORIGIN_X; // X-coordinate of the origin (0,0) on canvas
        let ORIGIN_Y; // Y-coordinate of the origin (0,0) on canvas
        const MAX_COORD = 10; // Max coordinate value (+/-10)

        const TOTAL_QUESTIONS = 5; // Total questions per game session
        const TIME_PER_QUESTION = 30; // Time in seconds per question

        let targetPoint = { x: 0, y: 0 }; // The current point to guess
        let currentScore = 0; // Score for current game session
        let questionCount = 0; // Questions answered in current game session
        let currentPlayer = {}; // Object to store current player's info
        // Load existing scores from LocalStorage or initialize an empty array
        let gameScores = JSON.parse(localStorage.getItem('graphGameScoresIdentifyV8')) || []; // Updated LocalStorage key for this version

        let timerInterval; // Stores the timer interval ID
        let timeLeft; // Remaining time for current question
        let gameIsOver = false; // Flag to indicate if the current game session has ended

        // Confetti settings using the confetti-js library
        let confettiInstance; // Instance of the confetti generator
        function initializeConfetti() {
            // Target the 'game-elements' div for confetti
            const confettiSettings = { 
                target: 'game-elements', 
                max: 80, // Max number of confetti particles
                size: 1.2, // Size multiplier for confetti
                clock: 20, // Speed of confetti
                props: ['circle', 'square', 'triangle', 'line'], // Shapes of confetti
                colors: [[165,104,246],[230,61,135],[0,199,228],[253,214,126]], // Array of colors
                // Width and height of confetti area should match the target div's size
                width: gameElements.offsetWidth, 
                height: gameElements.offsetHeight 
            };
            confettiInstance = new ConfettiGenerator(confettiSettings);
        }
        
        // Image Paths for the points on the graph (using placeholders from placehold.co)
        // You can replace these with paths to your actual image files like 'images/apple.png'
        const imagePaths = [
            'https://placehold.co/30/FF0000/FFFFFF?text=🍎', // Red apple
            'https://placehold.co/30/0000FF/FFFFFF?text=🔵', // Blue circle
            'https://placehold.co/30/00FF00/FFFFFF?text=🍀', // Green clover
            'https://placehold.co/30/FFFF00/000000?text=☀️', // Yellow sun
            'https://placehold.co/30/FF00FF/FFFFFF?text=💜', // Magenta heart
            'https://placehold.co/30/FFA500/FFFFFF?text=🍊', // Orange
            'https://placehold.co/30/800080/FFFFFF?text=🍇'  // Grape
        ];
        let currentImage = new Image(); // Image object to draw on canvas
        let usedImageIndices = []; // To ensure unique images per game session

        // --- Canvas Drawing Functions ---

        // Adjust canvas size and redraw elements when window is resized
        function resizeCanvas() {
            // Set canvas width to fill parent, but not exceed original intended size
            CANVAS_SIZE = Math.min(ORIGINAL_CANVAS_SIZE, canvas.clientWidth); 
            
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // Recalculate grid step and origin based on new CANVAS_SIZE
            GRID_STEP = CANVAS_SIZE / (MAX_COORD * 2); 
            ORIGIN_X = CANVAS_SIZE / 2;
            ORIGIN_Y = CANVAS_SIZE / 2;

            drawGrid(); // Redraw the grid
            // If an image is currently displayed, redraw it at the correct scaled position
            if (currentImage && currentImage.complete && questionCount > 0 && !gameIsOver && !startForm.classList.contains('hidden')) {
                drawImageOnGraph(currentImage, targetPoint.x, targetPoint.y);
            }

            // Update confetti canvas size if it exists and game elements are visible
            if (confettiInstance && !gameElements.classList.contains('hidden')) {
                confettiInstance.clear(); // Clear existing confetti instance
                initializeConfetti(); // Reinitialize confetti with updated size based on gameElements
            }
        }

        // Draw the coordinate grid with axes and numbers
        function drawGrid() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // Draw grid lines
            ctx.strokeStyle = '#E0E0E0'; // Light gray grid lines
            ctx.lineWidth = 0.8;
            for (let i = 0; i <= CANVAS_SIZE; i += GRID_STEP) {
                ctx.beginPath();
                ctx.moveTo(i, 0); ctx.lineTo(i, CANVAS_SIZE); ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i); ctx.lineTo(CANVAS_SIZE, i); ctx.stroke();
            }

            // Draw X and Y axes
            ctx.strokeStyle = '#424242'; // Dark gray axes
            ctx.lineWidth = 2.5;

            ctx.beginPath(); // X-axis
            ctx.moveTo(0, ORIGIN_Y); ctx.lineTo(CANVAS_SIZE, ORIGIN_Y); ctx.stroke();
            ctx.beginPath(); // Y-axis
            ctx.moveTo(ORIGIN_X, 0); ctx.lineTo(ORIGIN_X, CANVAS_SIZE); ctx.stroke();

            // Draw arrowheads for axes
            drawArrowhead(ctx, CANVAS_SIZE, ORIGIN_Y, 8, 4, 'horizontal'); // Right arrow
            drawArrowhead(ctx, 0, ORIGIN_Y, 8, -4, 'horizontal'); // Left arrow
            drawArrowhead(ctx, ORIGIN_X, 0, 8, -4, 'vertical'); // Up arrow
            drawArrowhead(ctx, ORIGIN_X, CANVAS_SIZE, 8, 4, 'vertical'); // Down arrow

            // Draw numbers on axes
            ctx.fillStyle = '#616161'; // Gray numbers
            ctx.font = '14px Kanit';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            for (let i = -MAX_COORD; i <= MAX_COORD; i += 1) {
                if (i === 0) continue; // Skip origin (0)
                ctx.fillText(i, ORIGIN_X + (i * GRID_STEP), ORIGIN_Y + 18); // X-axis numbers
                ctx.fillText(i, ORIGIN_X - 18, ORIGIN_Y - (i * GRID_STEP)); // Y-axis numbers
            }
             // Draw origin label (0)
            ctx.fillText('0', ORIGIN_X - 10, ORIGIN_Y + 10);
        }

        // Helper function to draw arrowheads for the axes
        function drawArrowhead(context, x, y, size, direction, axis) {
            context.save();
            context.beginPath();
            context.fillStyle = '#424242'; 
            if (axis === 'horizontal') {
                context.moveTo(x, y);
                context.lineTo(x - direction, y - size);
                context.lineTo(x - direction, y + size);
            } else { // vertical
                context.moveTo(x, y);
                context.lineTo(x - size, y - direction);
                context.lineTo(x + size, y - direction);
            }
            context.closePath();
            context.fill();
            context.restore();
        }

        // Draw an image at a specific graph coordinate
        function drawImageOnGraph(image, graphX, graphY) {
            // Image size scaled relative to grid step
            const imgSize = GRID_STEP * 1.8; // Make image slightly larger than a grid cell

            const centerX = ORIGIN_X + (graphX * GRID_STEP);
            const centerY = ORIGIN_Y - (graphY * GRID_STEP); // Y-axis is inverted on canvas
            ctx.drawImage(image, centerX - imgSize / 2, centerY - imgSize / 2, imgSize, imgSize);
        }

        // Draw an X mark to indicate a wrong answer or timeout
        function drawXMark(xCoord, yCoord, color = 'red', size = 30) {
            const canvasX = ORIGIN_X + (xCoord * GRID_STEP);
            const canvasY = ORIGIN_Y - (yCoord * GRID_STEP);
            const adjustedSize = size * (CANVAS_SIZE / ORIGINAL_CANVAS_SIZE); // Scale X mark size

            ctx.strokeStyle = color;
            ctx.lineWidth = 5;

            ctx.beginPath();
            ctx.moveTo(canvasX - adjustedSize / 2, canvasY - adjustedSize / 2);
            ctx.lineTo(canvasX + adjustedSize / 2, canvasY + adjustedSize / 2);
            ctx.moveTo(canvasX + adjustedSize / 2, canvasY - adjustedSize / 2);
            ctx.lineTo(canvasX - adjustedSize / 2, canvasY + adjustedSize / 2);
            ctx.stroke();

            // Clear the X mark after a short delay by redrawing the scene
            setTimeout(() => {
                drawGrid(); // Redraw grid to clear the mark
                drawImageOnGraph(currentImage, targetPoint.x, targetPoint.y); // Redraw the image
            }, 1000); 
        }

        // --- Game Logic Functions ---

        // Generates a random point and loads an image for the next question
        function generateRandomPointAndImage() {
            if (gameIsOver) return;

            questionCount++; // Increment question count for current game

            // End the game if all questions are done
            if (questionCount > TOTAL_QUESTIONS) {
                endGame();
                return;
            }

            // Generate random point (not (0,0)) within MAX_COORD range
            do {
                targetPoint.x = Math.floor(Math.random() * (MAX_COORD * 2 + 1)) - MAX_COORD;
                targetPoint.y = Math.floor(Math.random() * (MAX_COORD * 2 + 1)) - MAX_COORD;
            } while (targetPoint.x === 0 && targetPoint.y === 0);

            // Select a random image, ensuring uniqueness within the game cycle if enough images
            if (usedImageIndices.length === imagePaths.length) {
                usedImageIndices = []; // Reset if all images have been used
            }
            let imageIndex;
            do {
                imageIndex = Math.floor(Math.random() * imagePaths.length);
            } while (usedImageIndices.includes(imageIndex));
            usedImageIndices.push(imageIndex);

            currentImage.src = imagePaths[imageIndex];
            
            // Handle image loading success
            currentImage.onload = () => {
                drawGrid(); 
                drawImageOnGraph(currentImage, targetPoint.x, targetPoint.y); 

                // Reset UI elements for a new question
                answerXInput.value = '';
                answerYInput.value = '';
                answerQuadrantSelect.value = '';
                yourAnswerSpan.textContent = '-- รอคำตอบ --';
                correctAnswerSpan.textContent = '';
                messageDiv.textContent = 'กรอกคู่อันดับและจตุภาค';
                messageDiv.className = 'message info';
                updateScoreDisplay();

                // Enable inputs and buttons
                answerXInput.disabled = false;
                answerYInput.disabled = false;
                answerQuadrantSelect.disabled = false;
                checkAnswerBtn.disabled = false;
                newPointBtn.style.display = 'none'; // Hide "Next Point" button

                startTimer(); // Start timer for new question
            };
            // Handle image loading error
            currentImage.onerror = () => {
                console.error("Failed to load image: " + currentImage.src);
                // Fallback: draw a red point if image fails to load
                drawGrid();
                ctx.beginPath();
                ctx.arc(ORIGIN_X + (targetPoint.x * GRID_STEP), ORIGIN_Y - (targetPoint.y * GRID_STEP), 7, 0, Math.PI * 2);
                ctx.fillStyle = '#d50000'; // Red dot
                ctx.fill();
                ctx.closePath();
                
                // Reset UI elements and notify user
                answerXInput.value = ''; answerYInput.value = ''; answerQuadrantSelect.value = '';
                yourAnswerSpan.textContent = '-- รอคำตอบ --'; correctAnswerSpan.textContent = '';
                messageDiv.textContent = 'รูปภาพโหลดไม่ได้ (แสดงจุดสีแดงแทน) กรอกคำตอบได้เลย!';
                messageDiv.className = 'message wrong';
                updateScoreDisplay();

                answerXInput.disabled = false; answerYInput.disabled = false; answerQuadrantSelect.disabled = false;
                checkAnswerBtn.disabled = false;
                newPointBtn.style.display = 'none'; 
                
                startTimer(); 
            };
        }

        // Determine the quadrant of a given point
        function getQuadrant(x, y) {
            if (x > 0 && y > 0) return 'จตุภาคที่ 1';
            if (x < 0 && y > 0) return 'จตุภาคที่ 2';
            if (x < 0 && y < 0) return 'จตุภาคที่ 3';
            if (x > 0 && y < 0) return 'จตุภาคที่ 4';
            if (x === 0 && y !== 0) return 'บนแกน Y'; // On Y-axis, not origin
            if (x !== 0 && y === 0) return 'บนแกน X'; // On X-axis, not origin
            if (x === 0 && y === 0) return 'จุดกำเนิด (0,0)'; // Origin
            return 'ไม่ระบุ'; // Should not happen for valid coordinates
        }

        // --- Timer Functions ---
        function startTimer() {
            clearInterval(timerInterval); // Clear any existing timer
            timeLeft = TIME_PER_QUESTION; // Reset time
            timerDisplay.textContent = `เวลาที่เหลือ: ${timeLeft} วินาที`;
            timerDisplay.style.color = '#D32F2F'; // Initial red color

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `เวลาที่เหลือ: ${timeLeft} วินาที`;

                // Change timer color based on remaining time
                if (timeLeft <= 5) {
                    timerDisplay.style.color = 'red';
                } else if (timeLeft <= 15) {
                    timerDisplay.style.color = 'orange';
                } else {
                    timerDisplay.style.color = '#D32F2F';
                }

                // If time runs out, handle timeout
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000); // Update every second
        }

        // Stop the timer
        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Handles what happens when time runs out for a question
        function handleTimeout() {
            messageDiv.textContent = `หมดเวลา! คำตอบที่ถูกต้องคือ (${targetPoint.x}, ${targetPoint.y}), ${getQuadrant(targetPoint.x, targetPoint.y)}`;
            messageDiv.className = 'message wrong';
            correctAnswerSpan.textContent = `(${targetPoint.x}, ${targetPoint.y}), ${getQuadrant(targetPoint.x, targetPoint.y)}`;
            yourAnswerSpan.textContent = 'ไม่มีคำตอบ'; 

            // Disable inputs and buttons, show 'Next Point' button
            answerXInput.disabled = true;
            answerYInput.disabled = true;
            answerQuadrantSelect.disabled = true;
            checkAnswerBtn.disabled = true;
            newPointBtn.style.display = 'inline-block'; 
            
            drawXMark(targetPoint.x, targetPoint.y, '#D32F2F', 40); // Draw red X mark at the point

            updateScoreDisplay();

            // If all questions are done, end the game
            if (questionCount >= TOTAL_QUESTIONS) {
                newPointBtn.style.display = 'none';
                messageDiv.textContent += '. จบเกมแล้ว! กด "ดูคะแนนรวม" เพื่อดูผล';
                endGame();
            }
        }

        // --- Event Listeners ---

        // Check answer when button is clicked
        checkAnswerBtn.addEventListener('click', () => {
            if (gameIsOver) return; // Prevent answering if game is over
            stopTimer(); // Stop the timer as answer is submitted

            const userAnswerX = parseInt(answerXInput.value);
            const userAnswerY = parseInt(answerYInput.value);
            const userAnswerQuadrant = answerQuadrantSelect.value;

            // Input validation for user's answer fields
            if (isNaN(userAnswerX) || isNaN(userAnswerY) || userAnswerQuadrant === '') {
                messageDiv.textContent = '⚠️ กรุณากรอกคู่อันดับและเลือกจตุภาคให้ครบถ้วน!';
                messageDiv.className = 'message wrong';
                startTimer(); // Restart timer if input is incomplete
                return;
            }
            
            const correctQuadrant = getQuadrant(targetPoint.x, targetPoint.y);
            const isCorrectX = userAnswerX === targetPoint.x;
            const isCorrectY = userAnswerY === targetPoint.y;
            const isCorrectQuadrant = userAnswerQuadrant === correctQuadrant;

            yourAnswerSpan.textContent = `(${userAnswerX}, ${userAnswerY}), ${userAnswerQuadrant}`;
            correctAnswerSpan.textContent = `(${targetPoint.x}, ${targetPoint.y}), ${correctQuadrant}`;

            let scoreThisQuestion = 0;
            let feedbackMessage = '';

            // Check correctness and update feedback message
            if (isCorrectX && isCorrectY) {
                feedbackMessage += '✅ คู่อันดับถูกต้อง! ';
                scoreThisQuestion += 0.5; // Half point for correct ordered pair
            } else {
                feedbackMessage += '❌ คู่อันดับผิดพลาด. ';
            }

            if (isCorrectQuadrant) {
                feedbackMessage += '✅ จตุภาคถูกต้อง!';
                scoreThisQuestion += 0.5; // Half point for correct quadrant
            } else {
                feedbackMessage += '❌ จตุภาคผิดพลาด.';
            }

            // Update overall score and show feedback
            if (scoreThisQuestion === 1) { // If both parts are correct
                currentScore++;
                messageDiv.textContent = '✨ ยอดเยี่ยม! ' + feedbackMessage;
                messageDiv.className = 'message correct';
                if(confettiInstance) confettiInstance.render(); // Start confetti if available
                setTimeout(() => { if(confettiInstance) confettiInstance.clear(); }, 2000); // Clear after 2 seconds
            } else {
                messageDiv.textContent = '😅 ยังไม่ถูกต้อง. ' + feedbackMessage;
                messageDiv.className = 'message wrong';
                drawXMark(targetPoint.x, targetPoint.y, '#D32F2F', 40); // Draw red X mark
            }
            
            updateScoreDisplay();

            // Disable inputs/button after answer, show "Next Point" button
            answerXInput.disabled = true;
            answerYInput.disabled = true;
            answerQuadrantSelect.disabled = true;
            checkAnswerBtn.disabled = true;
            newPointBtn.style.display = 'inline-block'; 
            
            // If all questions for the game are answered, prepare for game end
            if (questionCount >= TOTAL_QUESTIONS) {
                newPointBtn.style.display = 'none';
                messageDiv.textContent += '. 🎉 จบเกมแล้ว! กด "ดูคะแนนรวม" เพื่อดูผล';
                endGame();
            }
        });

        // Start game button handler (from registration form)
        startGameBtn.addEventListener('click', () => {
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const studentClass = studentClassInput.value.trim();
            const studentId = parseInt(studentIdInput.value);

            // Validate all input fields for player registration
            if (firstName && lastName && studentClass && !isNaN(studentId) && studentId > 0) {
                currentPlayer = {
                    firstName: firstName,
                    lastName: lastName,
                    studentClass: studentClass,
                    studentId: studentId
                };
                // Hide start form and show game elements
                startForm.classList.add('hidden');
                gameElements.classList.remove('hidden');
                initializeConfetti(); // Initialize confetti now that game elements are visible
                startNewGame(); // Proceed to start the game
            } else {
                alert('⚠️ กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง!\n(ช่อง ชื่อ, สกุล, ชั้น ต้องไม่ว่างเปล่า และ เลขที่ต้องเป็นตัวเลขที่เป็นบวกเท่านั้น)'); 
            }
        });

        // "Next Point" button handler
        newPointBtn.addEventListener('click', () => {
            if (gameIsOver && questionCount >= TOTAL_QUESTIONS) {
                // If game is over and all questions are done, start a brand new game
                startNewGame(); 
            } else if (!gameIsOver) {
                // If game is ongoing, generate the next point
                generateRandomPointAndImage(); 
            }
        });

        // "Show Scores" button handler
        showScoresBtn.addEventListener('click', () => {
            stopTimer(); // Stop timer before leaving game screen
            displayScores(); // Populate the score board table
            mainContent.classList.remove('active'); // Hide main content with animation
            mainContent.classList.add('hidden'); // Then hide completely
            scoreBoard.classList.remove('hidden');
            scoreBoard.classList.add('active'); // Show scoreboard with animation
            if(confettiInstance) confettiInstance.clear(); // Clear confetti if still active
        });

        // "Back to Game" button handler (from score board)
        backToGameBtn.addEventListener('click', () => {
            scoreBoard.classList.remove('active'); // Hide scoreboard with animation
            scoreBoard.classList.add('hidden'); // Then hide completely
            mainContent.classList.remove('hidden');
            mainContent.classList.add('active'); // Show main content with animation
            
            // Resume game or prompt to start new one depending on game state
            if (!gameIsOver && questionCount < TOTAL_QUESTIONS) {
                // If game is ongoing, re-enable inputs and restart timer
                answerXInput.disabled = false;
                answerYInput.disabled = false;
                answerQuadrantSelect.disabled = false;
                checkAnswerBtn.disabled = false;
                startTimer(); 
            } else if (gameIsOver) {
                // If game has ended, prompt to start a new one
                messageDiv.textContent = 'กด "ข้อต่อไป" เพื่อเริ่มเล่นอีกครั้ง หรือ "ดูคะแนนรวม"';
                messageDiv.className = 'message info';
                newPointBtn.style.display = 'inline-block'; 
            }
        });

        // "Reset Game (เปลี่ยนผู้เล่น)" button handler
        resetGameBtn.addEventListener('click', () => {
            stopTimer(); // Stop any active timer
            if(confettiInstance) confettiInstance.clear(); // Clear any active confetti
            
            // Reset all game state variables
            gameIsOver = false;
            currentScore = 0;
            questionCount = 0;
            usedImageIndices = [];
            currentPlayer = {};

            // Clear input fields for a new player to register
            firstNameInput.value = '';
            lastNameInput.value = '';
            studentClassInput.value = '';
            studentIdInput.value = '';

            // Hide game elements and show the start form
            gameElements.classList.add('hidden');
            startForm.classList.remove('hidden');
            messageDiv.textContent = ''; // Clear previous messages
            messageDiv.className = '';
            yourAnswerSpan.textContent = '-- รอคำตอบ --';
            correctAnswerSpan.textContent = '';
            scoreDisplay.textContent = 'คะแนน: 0/0'; // Reset score display
            timerDisplay.textContent = `เวลาที่เหลือ: ${TIME_PER_QUESTION} วินาที`; // Reset timer display
            timerDisplay.style.color = '#D32F2F';

            // Ensure main content is visible and active for the registration form
            mainContent.classList.remove('hidden');
            mainContent.classList.add('active');
        });

        // --- Game Flow Control Functions ---

        // Initializes a new game session
        function startNewGame() {
            currentScore = 0;
            questionCount = 0; 
            usedImageIndices = []; // Reset used images for a new game
            gameIsOver = false; 
            playerInfoDisplay.textContent = `ผู้เล่น: ${currentPlayer.firstName} ${currentPlayer.lastName} ชั้น: ${currentPlayer.studentClass} เลขที่: ${currentPlayer.studentId}`;
            
            generateRandomPointAndImage(); // Start the first question
        }

        // Ends the current game session and records the score
        function endGame() {
            stopTimer(); // Stop timer
            gameIsOver = true; // Set game over flag
            alert(`🎉 ยินดีด้วย! ${currentPlayer.firstName} ${currentPlayer.lastName} ทำคะแนนได้ ${currentScore} จาก ${TOTAL_QUESTIONS} ข้อ! 🎉`);
            
            // Record game details and save to LocalStorage
            const now = new Date();
            const scoreEntry = {
                firstName: currentPlayer.firstName,
                lastName: currentPlayer.lastName,
                studentClass: currentPlayer.studentClass,
                studentId: currentPlayer.studentId,
                score: currentScore,
                totalQuestions: TOTAL_QUESTIONS,
                timestamp: now.toLocaleString('th-TH', { 
                    year: 'numeric', month: 'numeric', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                })
            };
            gameScores.push(scoreEntry);
            localStorage.setItem('graphGameScoresIdentifyV8', JSON.stringify(gameScores)); 

            // Reset game state for potential next play
            currentScore = 0; // Reset current score for new game
            usedImageIndices = []; // Reset used images
            newPointBtn.style.display = 'inline-block'; // Show "Next Point" button (or "Start New Game")
            drawGrid(); // Clear canvas
            yourAnswerSpan.textContent = '-- รอคำตอบ --';
            correctAnswerSpan.textContent = '';
            messageDiv.textContent = '🎉 จบเกมแล้ว! กด "ข้อต่อไป" เพื่อเริ่มเล่นใหม่ หรือ "ดูคะแนนรวม" เพื่อดูผลงานของคุณ!';
            messageDiv.className = 'message info';
            updateScoreDisplay(); 
            answerXInput.disabled = true; // Disable inputs
            answerYInput.disabled = true;
            answerQuadrantSelect.disabled = true;
            checkAnswerBtn.disabled = true; 
            timerDisplay.textContent = `เวลาที่เหลือ: ${TIME_PER_QUESTION} วินาที`; // Reset timer display
            timerDisplay.style.color = '#D32F2F'; 
            if(confettiInstance) confettiInstance.clear(); // Clear confetti
        }

        // Updates the score display on the UI
        function updateScoreDisplay() {
            scoreDisplay.textContent = `คะแนน: ${currentScore}/${questionCount}`;
            // When game ends, display total questions out of total
            if (gameIsOver && questionCount >= TOTAL_QUESTIONS) {
                 scoreDisplay.textContent = `คะแนน: ${currentScore}/${TOTAL_QUESTIONS}`; 
            }
        }

        // Populates the score board table and summary
        function displayScores() {
            scoresTableBody.innerHTML = ''; // Clear previous table rows
            individualScoresSummaryDiv.innerHTML = ''; // Clear previous summary

            // Aggregate scores by unique player for the summary section
            const playerSummary = {};
            gameScores.forEach(scoreEntry => {
                const playerKey = `${scoreEntry.firstName}_${scoreEntry.lastName}_${scoreEntry.studentClass}_${scoreEntry.studentId}`;
                if (!playerSummary[playerKey]) {
                    playerSummary[playerKey] = {
                        firstName: scoreEntry.firstName,
                        lastName: scoreEntry.lastName,
                        studentClass: scoreEntry.studentClass,
                        studentId: scoreEntry.studentId,
                        totalScore: 0,
                        totalQuestionsPlayed: 0,
                        gamesPlayed: 0
                    };
                }
                playerSummary[playerKey].totalScore += scoreEntry.score;
                playerSummary[playerKey].totalQuestionsPlayed += scoreEntry.totalQuestions;
                playerSummary[playerKey].gamesPlayed++;
            });

            // Sort aggregated player summary by average score (descending)
            const sortedPlayerSummary = Object.values(playerSummary).sort((a, b) => {
                const avgA = a.totalQuestionsPlayed > 0 ? a.totalScore / a.totalQuestionsPlayed : 0;
                const avgB = b.totalQuestionsPlayed > 0 ? b.totalScore / b.totalQuestionsPlayed : 0;
                return avgB - avgA;
            });

            // Display individual player summaries
            if (sortedPlayerSummary.length === 0) {
                individualScoresSummaryDiv.textContent = 'ยังไม่มีข้อมูลคะแนนรวม';
            } else {
                sortedPlayerSummary.forEach(player => {
                    const avgScore = player.totalQuestionsPlayed > 0 ? (player.totalScore / player.totalQuestionsPlayed * 100).toFixed(2) : 0;
                    const summaryP = document.createElement('p');
                    summaryP.innerHTML = `🌟 <strong>${player.firstName} ${player.lastName} (${player.studentClass}/${player.studentId}):</strong> เล่นไป ${player.gamesPlayed} ครั้ง, คะแนนรวม ${player.totalScore}/${player.totalQuestionsPlayed} (เฉลี่ย ${avgScore}%)`;
                    individualScoresSummaryDiv.appendChild(summaryP);
                });
            }

            // Sort individual game entries by score (descending) and then by timestamp (newest first)
            gameScores.sort((a, b) => b.score - a.score || new Date(b.timestamp) - new Date(a.timestamp)); 

            // Populate the main scores table
            if (gameScores.length === 0) {
                const row = scoresTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7; // Span across all columns
                cell.textContent = 'ยังไม่มีประวัติการเล่น';
            } else {
                gameScores.forEach((score, index) => {
                    const row = scoresTableBody.insertRow();
                    row.insertCell().textContent = index + 1; // Rank
                    row.insertCell().textContent = score.firstName;
                    row.insertCell().textContent = score.lastName;
                    row.insertCell().textContent = score.studentClass;
                    row.insertCell().textContent = score.studentId;
                    row.insertCell().textContent = `${score.score}/${score.totalQuestions}`; // Score
                    row.insertCell().textContent = score.timestamp; // Date/Time
                });
            }
        }

        // --- Initial Setup ---
        // Call resizeCanvas initially and on window resize to make it responsive
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Hide game elements and scoreboard, show start form initially
        gameElements.classList.add('hidden'); 
        scoreBoard.classList.add('hidden'); 
        startForm.classList.remove('hidden'); // Ensure start form is visible
        mainContent.classList.add('active'); // Ensure main container is active on load
    </script>
</body>
</html>